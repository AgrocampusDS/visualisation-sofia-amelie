---
title: "Projet Visualisation"
author: "Sofia Chemolli & Amélie Rivet"
output: pdf_document
---

# Création du jeu de données.

Importation des packages.

```{r}
library(ggplot2)
library(tidyverse)
library(dplyr)
library(readxl)
library(plotly)
library(flexdashboard)
```

Importation des données.

```{r}
# Espérance de vie
dta_esp <- read.csv("LifeExpectancyData.csv", stringsAsFactors = T)
dta_esp$Year <- as.factor(dta_esp$Year)
dta_esp <- dta_esp[,c(1,2,4)]


# Codes ISO3
code <- read_excel("CodeISO3.xlsx")
code$ISO3 <- as.factor(code$ISO3)


# GDP
dta_GDP <- read.csv("GDP_data.csv", sep=",", stringsAsFactors = T)
dta_GDP <- dta_GDP[,4:20]
colnames(dta_GDP) <- c("ISO3","2000", "2001", "2002","2003", "2004", "2005","2006", "2007", "2008","2009","2010", "2011", "2012","2013", "2014", "2015")

dta_GDP <- dta_GDP %>% 
  pivot_longer(c("2000", "2001", "2002","2003", "2004", "2005","2006", "2007", "2008","2009","2010", "2011", "2012","2013", "2014", "2015"))
colnames(dta_GDP)[2:3] <- c("Year", "GDP")
dta_GDP$Year <- as.factor(dta_GDP$Year)


# Dépensés par personne
dta_dep <- read.csv("Dep_data.csv", sep=",", stringsAsFactors = T)
dta_dep <- dta_dep[,4:20]
colnames(dta_dep) <- c("ISO3","2000", "2001", "2002","2003", "2004", "2005","2006", "2007", "2008","2009","2010", "2011", "2012","2013", "2014", "2015")

dta_dep <- dta_dep %>% 
  pivot_longer(c("2000", "2001", "2002","2003", "2004", "2005","2006", "2007", "2008","2009","2010", "2011", "2012","2013", "2014", "2015"))
colnames(dta_dep)[2:3] <- c("Year", "Depense")
dta_dep$Year <- as.factor(dta_dep$Year)
```

Merge des jeux de données.

```{r}
dta_esp <- left_join(dta_esp, code, by = "Country")

dta <- left_join(dta_esp, dta_dep, by = c("ISO3","Year"))

dta <- left_join(dta, dta_GDP, by = c("ISO3","Year"))
```

Calcul des différences des espérance de vie.

```{r}
# Country
dta.diff <- dta %>% 
  group_by(ISO3) %>%
  summarise(Life.expectancy.diff = Life.expectancy[Year=='2015'] - Life.expectancy[Year=='2000'], 
            Depense.diff = Depense[Year=='2015'] - Depense[Year=='2000'], 
            GDP.diff = GDP[Year=='2015'] - GDP[Year=='2000']) %>%
  arrange(Life.expectancy.diff)

# ISO3
dta.diff.ISO3 <- dta %>% 
  group_by(ISO3) %>%
  summarise(Life.expectancy.diff = Life.expectancy[Year=='2015'] - Life.expectancy[Year=='2000'],
            Country = Country,
            Life.expectancy.2000 = Life.expectancy[Year=='2000'],
            Life.expectancy.2015 = Life.expectancy[Year=='2015'])

# Pour la carte ggplot
dta.diff1 <- dta %>% 
  group_by(Country) %>%
  summarise(Life.expectancy.diff = Life.expectancy[Year=='2015'] - Life.expectancy[Year=='2000']) %>%
  arrange(Life.expectancy.diff)

```

# Visu 1 : carte

## Version ggplot

Préparation des données qui concernent la latitude et la longitude.

```{r}
world_map = map_data("world")[,-6]

colnames(world_map)[5] = "Country"

setdiff(dta$Country, world_map$Country)
world_map[world_map$Country == "Antigua",]$Country = "Antigua and Barbuda"
world_map[world_map$Country == "Barbuda",]$Country = "Antigua and Barbuda"
world_map[world_map$Country == "Bolivia",]$Country = "Bolivia (Plurinational State of)"
world_map[world_map$Country == "Brunei",]$Country = "Brunei Darussalam"
world_map[world_map$Country == "Ivory Coast",]$Country = "Côte d'Ivoire"
world_map[world_map$Country == "Cape Verde",]$Country = "Cabo Verde"
world_map[world_map$Country == "Czech Republic",]$Country = "Czechia"
world_map[world_map$Country == "Republic of Congo",]$Country = "Congo"
world_map[world_map$Country == "North Korea",]$Country = "Democratic People's Republic of Korea"
world_map[world_map$Country == "Iran",]$Country = "Iran (Islamic Republic of)"
world_map[world_map$Country == "Laos",]$Country = "Lao People's Democratic Republic"
world_map[world_map$Country == "Micronesia",]$Country = "Micronesia (Federated States of)"
world_map[world_map$Country == "South Korea",]$Country = "Republic of Korea"
world_map[world_map$Country == "Moldova",]$Country = "Republic of Moldova"
world_map[world_map$Country == "Russia",]$Country = "Russian Federation"
world_map[world_map$Country == "Syria",]$Country = "Syrian Arab Republic"
world_map[world_map$Country == "Saint Kitts",]$Country = "Saint Kitts and Nevis"
world_map[world_map$Country == "Nevis",]$Country = "Saint Kitts and Nevis"
world_map[world_map$Country == "Saint Vincent",]$Country = "Saint Vincent and the Grenadines"
world_map[world_map$Country == "Grenadines",]$Country = "Saint Vincent and the Grenadines"
world_map[world_map$Country == "North Macedonia",]$Country = "The former Yugoslav republic of Macedonia"
world_map[world_map$Country == "Trinidad",]$Country = "Trinidad and Tobago"
world_map[world_map$Country == "Tobago",]$Country = "Trinidad and Tobago"
world_map[world_map$Country == "UK",]$Country = "United Kingdom of Great Britain and Northern Ireland"
world_map[world_map$Country == "Tanzania",]$Country = "United Republic of Tanzania"
world_map[world_map$Country == "USA",]$Country = "United States of America"
world_map[world_map$Country == "Venezuela",]$Country = "Venezuela (Bolivarian Republic of)"
world_map[world_map$Country == "Vietnam",]$Country = "Viet Nam"
setdiff(dta$Country, world_map$Country)

life.exp.map <- left_join(dta.diff1, world_map, by = "Country")
n_distinct(life.exp.map[,1])
```

Compute the centroid as the mean longitude and lattitude used as label coordinate.

```{r}
position <- world_map %>%
  group_by(Country) %>%
  summarise(long = mean(long), lat = mean(lat)) 

dta.2015 <- dta %>% 
  filter(Year=="2015")

position.map <- left_join(dta.2015, position, by = "Country")
```

Carte statique (ggplot).

```{r}
ggplot(life.exp.map, aes(long, lat))+
  
  geom_polygon(aes(group = group, fill = Life.expectancy.diff), color = "black") +
  
  theme_classic() + # fond blanc
  
  xlab("") + # on enlève les labels de l'axe x 
  
  ylab("") + # on enlève les labels de l'axe y 
  
  labs(fill='Diff', # titre de la légende
       title="Différence des espérance de vie (2015-2000)" # ajout du titre
  ) +
  
  theme(axis.line = element_blank(), # enlever les axes 
        
        axis.ticks =  element_blank(), # enlever les traits des axes
        
        axis.text = element_blank(), # enlever les labels des axes
        
        plot.title = element_text(hjust = 0.5) # centrer le titre
  ) + 
  
  scale_fill_viridis_c(option = "C") +
  
  geom_text(aes(label = Life.expectancy), data = position.map,  size = 3, hjust = 0.5, col="white")
```

## Version plotly

Carte interactive (plot_ly).

```{r}
fig <- plot_ly(dta.diff.ISO3, 
               
               type = 'choropleth', 
               
               locations = dta.diff.ISO3$ISO3, 
               
               z = dta.diff.ISO3$Life.expectancy.diff, 
               
               text = paste("Pays : ", dta.diff.ISO3$Country, '<br>', 
                            "Esperance de vie en 2000 : ", dta.diff.ISO3$Life.expectancy.2000, '<br>', 
                            "Esperance de vie en 2015 : ", dta.diff.ISO3$Life.expectancy.2015, '<br>', 
                            "Difference : ", dta.diff.ISO3$Life.expectancy.diff), 
               
               colorscale = "YlGnBu",
               
               hoverinfo = 'text')

fig %>% 
  colorbar(title =  "Différence de \n l'espérance de vie \n entre 2015 et 2000")%>% 
  layout(title = "Différence de l'espérance de vie (2015-2000)",
         legend = list(zanchor = "middle"))
```

# Visu 2

```{r}
expectancy <- inner_join(dta, dta.diff, by='ISO3')

expectancy.2000 <- expectancy %>% 
  filter(Year==2000)

expectancy.2000[,5]<-round(expectancy.2000[,5],1)
expectancy.2000[,6]<-round(expectancy.2000[,6],1)
expectancy.2000[,8]<-round(expectancy.2000[,8],1)
expectancy.2000[,9]<-round(expectancy.2000[,9],1)

summary(expectancy.2000)

g1 <- ggplotly(ggplot(data = expectancy.2000, 
                      aes(x = Depense.diff, y = Life.expectancy.diff, 
                          text = paste("Pays : ", Country, 
                                       "<br>Espérance de vie en 2000 : ", Life.expectancy, 
                                       "<br>Dépenses en santé en 2000 : ", Depense," USD")), 
                      na.rm=TRUE) +
                 
                 geom_point(aes(color=Life.expectancy, size=Depense)) +
                 
                 scale_color_gradient(low ="#FFFF99",high = "#009933") +
                 
                 scale_y_continuous(breaks=seq(-10, 20, 5)) +
                 
                 scale_x_continuous(breaks=seq(0, 6000, 1000)) +
                 
                 labs(x = "Différences des dépenses en santé par habitant entre 2000 et 2015 (USD)",
                      y = "Différences d'espérance de vie entre 2000 et 2015",
                      colour = "Espérance de vie",
                      size = "Dépenses en santé \n par habitant") +
                 
                 ggtitle("Représentation de la relation espérance de vie - dépense en santé") +
                 
                 theme(plot.title = element_text(face="bold", hjust=0.5, size=10), 
                       axis.title.x = element_text(size=9),
                       axis.title.y = element_text(size=9),
                       panel.background = element_rect(fill = "white"),
                       panel.grid.major = element_line(colour = "#CCCCCC"),
                       plot.margin = unit(c(1,1,1,1), "cm")), tooltip="text")

g1 %>% layout(showlegend=TRUE)

g2 <- ggplotly(ggplot(data = expectancy.2000, 
                      aes(x = GDP.diff, y = Life.expectancy.diff, 
                          text=paste("Pays : ",Country,
                                     "<br>Espérance de vie en 2000 : ", Life.expectancy, 
                                     "<br>GDP en 2000 : ", GDP)), 
                      na.rm=TRUE) +
                 
                 geom_point(aes(color=Life.expectancy, size=GDP)) +
                 
                 scale_color_gradient(low ="#FFFF99",high = "#009933") +
                 
                 scale_y_continuous(breaks=seq(-10, 20, 5)) +
                 
                 scale_x_continuous(breaks=seq(-10000, 60000, 10000)) +
                 
                 labs(x = "Différences de GDP par habitant entre 2000 et 2015",
                      y = "Différences d'espérance de vie entre 2000 et 2015",
                      colour = "Espérance de vie",
                      size = "GDP par habitant") +
                 
                 ggtitle("Représentation de la relation espérance de vie - GDP") +
                 
                 theme(plot.title = element_text(face="bold", hjust=0.5, size=10), 
                       axis.title.x = element_text(size=9),
                       axis.title.y = element_text(size=9),
                       panel.background = element_rect(fill = "white"),
                       panel.grid.major = element_line(colour = "#CCCCCC"),
                       plot.margin = unit(c(1,1,1,1), "cm")), tooltip="text")

g2 %>% layout(showlegend=TRUE)
```